# IR Normalization Tool - README

## Overview

This tool normalizes LLVM IR output to enable semantic-only comparisons during differential testing. It removes or canonicalizes elements that can vary between compiler runs without affecting the actual behavior of the compiled code.

## Purpose

When comparing outputs from different compiler stages (e.g., aster0 vs aster1), we need to ignore:
- Formatting differences (whitespace, indentation)
- Symbol name variations (temp variable numbering)
- Comment differences
- Metadata ordering
- Non-semantic debug information

This allows differential tests to focus on actual semantic differences.

## Usage

### Basic Usage
```bash
./normalize.sh input.ll output.ll
```

### In-place Normalization
```bash
./normalize.sh file.ll
# Creates file_normalized.ll
```

### In Differential Testing
```bash
# Compile with both compilers
aster0 build test.ast -o test0.ll
aster1 build test.ast -o test1.ll

# Normalize both outputs
./normalize.sh test0.ll test0_norm.ll
./normalize.sh test1.ll test1_norm.ll

# Compare normalized outputs
diff test0_norm.ll test1_norm.ll
```

## Normalization Steps

1. **Comment Removal**: Strips all comment lines (starting with `;`)
2. **Whitespace Normalization**: Converts multiple spaces to single space
3. **Empty Line Removal**: Removes blank lines
4. **Trailing Space Removal**: Strips spaces at end of lines
5. *(Future)* Symbol renaming: Canonicalizes temporary variable names
6. *(Future)* Block sorting: Sorts basic blocks by label
7. *(Future)* Metadata removal: Strips variable metadata

## Implementation

Current implementation is a simple shell script using `grep` and `sed`.

Future enhancements could use a proper LLVM IR parser for more sophisticated normalization.

## Examples

### Before Normalization
```llvm
; Generated by aster0
define i32 @main() {
entry:
  %0 = add i32 10, 20
  
  ret i32 %0
}
```

### After Normalization
```llvm
define i32 @main() {
entry:
 %0 = add i32 10, 20
 ret i32 %0
}
```

## Integration with Bootstrap

This tool is automatically used in the bootstrap verification process:

```bash
# In scripts/bootstrap_stage1.sh
./tools/ir_normalize/normalize.sh build/test0.ll build/test0_norm.ll
./tools/ir_normalize/normalize.sh build/test1.ll build/test1_norm.ll
diff build/test0_norm.ll build/test1_norm.ll || echo "Outputs differ!"
```

## Requirements

- Bash shell
- Standard Unix tools: `grep`, `sed`, `wc`

## Limitations

- Current version is basic - may not catch all semantic equivalences
- Does not handle complex LLVM IR constructs
- Does not perform symbolic execution or semantic analysis

For complete verification, normalized IR comparison should be supplemented with:
- Execution tests (both produce same output when run)
- Binary comparison (for deterministic builds)
- Type checking of generated IR

## Future Enhancements

- [ ] Proper LLVM IR parsing
- [ ] Symbol table canonicalization
- [ ] Basic block sorting
- [ ] Metadata stripping
- [ ] SSA renaming for comparison
- [ ] Control flow graph comparison
